<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Book Reader</title>
  <link href="./css/main.css" rel="stylesheet" type="text/css"/>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.min.js"></script>
  <script src="./lib/easeljs-NEXT.combined.js"></script>
  <script src="./lib/preloadjs-NEXT.combined.js"></script>
  <script src="./lib/TweenMax.js"></script>
  <script src="../easeljs_book_reader/src/book_reader.js"></script>

<script type="text/javascript">

  var stage;
  var stageWidth;
  var stageHeight;
  var br; // book reader
  var manifest;

  CANVAS_WIDTH = 2000;
  CANVAS_HEIGHT = 700;

  BOOK_WIDTH = 1844;
  BOOK_HEIGHT = 700;

  function init() {
    setupStage();
    addBookReader();
    addImages();
  }

  function getDevicePixelRatio() {
    var ratio;
    ratio = 1;
    if ((window.screen.systemXDPI != null) && (window.screen.logicalXDPI != null) && window.screen.systemXDPI > window.screen.logicalXDPI) {
      ratio = window.screen.systemXDPI / window.screen.logicalXDPI;
    } else if (window.devicePixelRatio != null) {
      ratio = window.devicePixelRatio;
    }
    return ratio;
  }

  function setupStage() {
    var canvas = document.getElementById("maincanvas");
    stage = new createjs.Stage(canvas);
    stage.enableMouseOver();
    stageWidth = canvas.width;
    stageHeight = canvas.height;
    createjs.Ticker.addEventListener("tick", stage);

    // css
    canvas = $("#maincanvas")
    canvasElement = canvas[0]
    canvas.width(CANVAS_WIDTH)
    canvas.height(CANVAS_HEIGHT)

    pixelRatio = getDevicePixelRatio()
    canvasElement.width = CANVAS_WIDTH * pixelRatio
    canvasElement.height = CANVAS_HEIGHT * pixelRatio
  }

  function addBookReader() {
    options = {
      numPages: 0,
      x: 0,
      y: 0,
      pageWidth: BOOK_WIDTH/2,
      pageHeight: BOOK_HEIGHT,
      pageGap: 0,
      startPage: 0
    }

    cnt = new createjs.Container()
    stage.addChild(cnt)
    br = new BookReader(cnt, options)
    cnt.x = (2000 - BOOK_WIDTH)/2
  }

  function addImages() {

    var picasa = {
      username : 'your_Picasa_id',
      albumId : 'your_album_id',
      count : 14
    }
    photoFeed = "https://picasaweb.google.com/data/feed/base/user/111691737910533878984/albumid/6150524963620273041?alt=json&callback=?&hl=en_US";

    manifest = [];
    $.getJSON(photoFeed, function(data) {
      console.log('hi data', data);
      $.each(data.feed.entry, function(index){
        manifest.push({src: data.feed.entry[index].content.src, id: data.feed.entry[index].title.$t});
      })
      numPages = manifest.length + manifest.length % 2; // must be even pages
      br.addBlankPages(numPages)
      loadManifest(manifest)
    })
  }

  function loadManifest(manifest) {
    console.log('load manifest', manifest);
    queue = new createjs.LoadQueue(false);
    //queue.on("complete", createjs.proxy(handleComplete, this));
    queue.on("fileload", createjs.proxy(handleFileLoad, this));
    queue.loadManifest(manifest, true);
  }

  createjs.Bitmap.prototype.fitInto = function(width, height) {
    scaleX = width / this.image.width;
    scaleY = height / this.image.height;
    this.scaleX = this.scaleY = Math.min(scaleX, scaleY);
  }

  function handleFileLoad(e) {
    page = br.getPageContainer(e.currentTarget._numItemsLoaded-1)
    img = e.result
    bmp = new createjs.Bitmap(img)
    scaleX = br.pageWidth / img.width;
    scaleY = br.pageHeight / img.height;
    scale = Math.min(scaleX, scaleY);
    bmp.scaleX = bmp.scaleY = scale
    bmp.x = (br.pageWidth - img.width*scale)/2
    bmp.y = (br.pageHeight - img.height*scale)/2
    bmp.cache(0, 0, img.width, img.height, scale)

    page.addChild(bmp)
  }

</script>
</head>

<body onload="init()">
<header>
</header>

<div id='background'>
  <canvas id="maincanvas" width="2000" height="700"></canvas>
</div>

</body>
</html>
